#!/usr/bin/env bash
#
# usage: ./run command [argument ...]
#
# Commands for halos-mdns-publisher development.
#
# See https://death.andgravity.com/run-sh
# for an explanation of how it works and why it's useful.

set -o nounset
set -o pipefail
set -o errexit

# Change the current directory to the project root.
PROJECT_ROOT=${0%/*}
if [[ $0 != $PROJECT_ROOT && $PROJECT_ROOT != "" ]]; then
  cd "$PROJECT_ROOT"
fi
readonly PROJECT_ROOT=$(pwd)

# Docker image for Linux builds
DOCKER_IMAGE="rust-debtools:latest"

# Helper function to run cargo commands in Docker
function docker-cargo {
  docker run --rm \
    -v "$(pwd):/build" \
    -w /build \
    "$DOCKER_IMAGE" \
    "$@"
}

# Helper function to ensure Docker image exists
function ensure-docker-image {
  if ! docker image inspect "$DOCKER_IMAGE" &>/dev/null; then
    echo "ðŸ³ Building Docker image for Linux builds..."
    docker build -t "$DOCKER_IMAGE" -f docker/Dockerfile.debtools docker/
    echo "âœ… Docker image built"
  fi
}

################################################################################
# Rust Development Commands (all run in Docker for Linux compatibility)

function build {
  #@ Build Rust binary (debug mode, x86_64 Linux)
  #@ Category: Build
  ensure-docker-image
  echo "ðŸ”¨ Building halos-mdns-publisher (debug, x86_64 Linux)..."
  docker-cargo cargo build
  echo "âœ… Build complete: target/debug/halos-mdns-publisher"
}

function build-release {
  #@ Build Rust binary (release mode, x86_64 Linux)
  #@ Category: Build
  ensure-docker-image
  echo "ðŸ”¨ Building halos-mdns-publisher (release, x86_64 Linux)..."
  docker-cargo cargo build --release
  echo "âœ… Build complete: target/release/halos-mdns-publisher"
}

function test {
  #@ Run all tests (in Docker)
  #@ Category: Test
  ensure-docker-image
  echo "ðŸ§ª Running tests..."
  docker-cargo cargo test
}

function check {
  #@ Run cargo check (fast compile check, in Docker)
  #@ Category: Test
  ensure-docker-image
  echo "ðŸ” Running cargo check..."
  docker-cargo cargo check
}

function clippy {
  #@ Run clippy linter (in Docker)
  #@ Category: Test
  ensure-docker-image
  echo "ðŸ“Ž Running clippy..."
  docker-cargo cargo clippy --all-targets --all-features -- -D warnings
}

function fmt {
  #@ Format code with rustfmt
  #@ Category: Test
  echo "ðŸŽ¨ Formatting code..."
  # rustfmt can run natively - it doesn't need Linux-specific dependencies
  cargo fmt
}

function fmt-check {
  #@ Check code formatting
  #@ Category: Test
  echo "ðŸ” Checking code format..."
  # rustfmt can run natively - it doesn't need Linux-specific dependencies
  cargo fmt --check
}

function lint {
  #@ Run all linting (fmt check + clippy in Docker)
  #@ Category: Test
  fmt-check
  clippy
}

################################################################################
# Debian Packaging

function build-deb {
  #@ Build Debian package for arm64
  #@ Category: Package
  echo "ðŸ“¦ Building Debian package..."
  .github/scripts/build-deb-package.sh
}

function check-lintian {
  #@ Run lintian on built package
  #@ Category: Package
  local deb_file
  deb_file=$(ls -t *.deb 2>/dev/null | head -1)
  if [[ -z "$deb_file" ]]; then
    echo "âŒ No .deb file found. Run 'build-deb' first."
    exit 1
  fi
  echo "ðŸ” Running lintian on $deb_file..."
  docker run --rm -v "$(pwd):/build" -w /build "$DOCKER_IMAGE" \
    lintian --info --display-info --fail-on error,warning "$deb_file"
  echo "âœ… Lintian check passed"
}

################################################################################
# Development Setup

function hooks-install {
  #@ Install pre-commit hooks using lefthook
  #@ Category: Setup
  if ! command -v lefthook &> /dev/null; then
    echo "Error: lefthook not found. Install with: brew install lefthook"
    exit 1
  fi
  lefthook install
  echo "âœ… Pre-commit hooks installed"
}

function hooks-run {
  #@ Run pre-commit hooks manually
  #@ Category: Setup
  if ! command -v lefthook &> /dev/null; then
    echo "Error: lefthook not found. Install with: brew install lefthook"
    exit 1
  fi
  lefthook run pre-commit
}

################################################################################
# Version Management Commands

function bumpversion {
  #@ Bump version using bumpversion tool (patch|minor|major)
  #@ Category: Version
  local BUMP_TYPE="${1:-}"

  if [[ -z "$BUMP_TYPE" ]]; then
    echo "Error: version bump type required"
    echo "Usage: ./run bumpversion [patch|minor|major]"
    exit 1
  fi

  if [[ ! "$BUMP_TYPE" =~ ^(patch|minor|major)$ ]]; then
    echo "Error: invalid bump type '$BUMP_TYPE'"
    echo "Usage: ./run bumpversion [patch|minor|major]"
    exit 1
  fi

  echo "Bumping $BUMP_TYPE version..."

  if ! command -v bumpversion &> /dev/null; then
    echo "Error: bumpversion not installed"
    echo "Install with: pip install bump2version"
    exit 1
  fi

  command bumpversion "$BUMP_TYPE"

  echo "Version bumped and committed successfully"
  echo "New version: $(cat VERSION)"
  echo "Push with: git push"
}

################################################################################
# Help System

function help {
  #@ Show this help message
  #@ Category: Help
  echo "HaLOS mDNS Publisher - Development Commands"
  echo "============================================"
  echo ""
  echo "NOTE: This is a Linux-only project. Build/test commands run in Docker."
  echo ""
  echo "Available commands:"
  echo ""

  # Extract function definitions and their help comments
  awk '/^function / {
    fname = $2
    sub(/[({].*/, "", fname)
    getline
    if ($0 ~ /#@/) {
      desc = $0
      sub(/.*#@ /, "", desc)
      sub(/ *$/, "", desc)
      getline
      if ($0 ~ /#@ Category:/) {
        cat = $0
        sub(/.*Category: /, "", cat)
        sub(/ *$/, "", cat)
        if (!seen[cat]++) categories[++cat_count] = cat
        commands[cat, ++cmd_count[cat]] = fname
        descriptions[cat, cmd_count[cat]] = desc
      }
    }
  }
  END {
    for (i = 1; i <= cat_count; i++) {
      cat = categories[i]
      print "\n" cat ":"
      for (j = 1; j <= cmd_count[cat]; j++) {
        printf "  %-20s %s\n", commands[cat, j], descriptions[cat, j]
      }
    }
  }' "$0"

  echo ""
  echo "Usage: ./run <command> [arguments...]"
}

################################################################################
# Main dispatcher

TIMEFORMAT=$'\nTask completed in %3lR'
time "${@:-help}"
