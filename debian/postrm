#!/bin/sh
set -e

# Revert nsswitch.conf changes on purge
# Restores mdns4_minimal which is the Debian default
revert_nsswitch() {
    NSSWITCH="/etc/nsswitch.conf"
    if [ -f "$NSSWITCH" ]; then
        # Only revert if we previously changed it (mdns4 without _minimal)
        # Be careful not to match mdns4_minimal
        if grep -q 'mdns4\b' "$NSSWITCH" && ! grep -q 'mdns4_minimal' "$NSSWITCH"; then
            echo "Reverting nsswitch.conf mDNS configuration..."
            sed -i 's/\bmdns4\b/mdns4_minimal/g' "$NSSWITCH"
            echo "nsswitch.conf reverted: mdns4 -> mdns4_minimal"
        elif grep -q 'mdns\b' "$NSSWITCH" && ! grep -q 'mdns_minimal' "$NSSWITCH"; then
            sed -i 's/\bmdns\b/mdns_minimal/g' "$NSSWITCH"
            echo "nsswitch.conf reverted: mdns -> mdns_minimal"
        fi
    fi
}

case "$1" in
    remove)
        # Stop and disable the service if it's running
        if [ -d /run/systemd/system ]; then
            systemctl stop halos-mdns-publisher.service 2>/dev/null || true
            systemctl disable halos-mdns-publisher.service 2>/dev/null || true
            systemctl daemon-reload
        fi
        ;;
    purge)
        # Stop and disable the service if it's running
        if [ -d /run/systemd/system ]; then
            systemctl stop halos-mdns-publisher.service 2>/dev/null || true
            systemctl disable halos-mdns-publisher.service 2>/dev/null || true
            systemctl daemon-reload
        fi
        # Revert nsswitch.conf changes
        revert_nsswitch
        ;;
esac

#DEBHELPER#

exit 0
